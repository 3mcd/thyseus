(function(f,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(f=typeof globalThis<"u"?globalThis:f||self,p(f.Thyseus={}))})(this,function(f){"use strict";var p=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},w=(e,t,s)=>(p(e,t,"read from private field"),s?s.call(e):t.get(e)),z=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},U=(e,t,s,i)=>(p(e,t,"write to private field"),i?i.call(e,s):t.set(e,s),s),y,A;const x="@IS_SENT_BY_THREAD",Y=Symbol(),J=Symbol(),h={Send:Y,Receive:J},q=class{constructor(e,t){z(this,y,void 0),z(this,A,void 0),U(this,y,e),U(this,A,t)}static spawn(e,t,s){return!t||e===0?[]:q.Context.Main?Array.from({length:e},()=>new this(new Worker(t,{type:"module"}),s)):[new this(globalThis,s)]}static execute(e,t){e&&t()}static async createOrReceive(e,t,s){if(e){const i=s();return t.forEach(n=>n.send(i)),i}else return(await Promise.all(t.map(n=>n.receive())))[0]}send(e){return w(this,y).postMessage(_(e,w(this,A))),this}receive(e=3e3){return new Promise((t,s)=>{let i=setTimeout(()=>{s("Timed out."),w(this,y).removeEventListener("message",n)},e);const n=o=>{clearTimeout(i),t(R(o.data,w(this,A))),w(this,y).removeEventListener("message",n)};w(this,y).addEventListener("message",n)})}};let c=q;y=new WeakMap,A=new WeakMap,c.Context={Main:!!globalThis.document,Worker:!globalThis.document};function S(e){return typeof e=="function"&&h.Receive in e&&h.Send in e.prototype}function Z(e){return h.Send in e}function tt(e){return Array.isArray(e)&&e.length===3&&e[0]===x}function _(e,t){if(typeof e!="object"||e===null)return e;if(Z(e))return[x,t.indexOf(Object.getPrototypeOf(e).constructor),_(e[h.Send](),t)];for(const s in e)e[s]=_(e[s],t);return e}function R(e,t){if(typeof e!="object"||e===null||e instanceof Object.getPrototypeOf(Uint8Array)||e instanceof DataView||e instanceof ArrayBuffer||typeof SharedArrayBuffer!==void 0&&e instanceof SharedArrayBuffer)return e;if(tt(e)){const[,s,i]=e,n=R(i,t);return t[s][h.Receive](n)}for(const s in e)e[s]=R(e[s],t);return e}const C=0b11111111n;class M{static with(t,s,i=!1){const n=i?SharedArrayBuffer:ArrayBuffer;return new this(t,s,new Uint8Array(new n(Math.ceil(t/8)*s)))}#t;#e;constructor(t,s,i){this.width=t,this.length=s,this.#e=i,this.#t=Math.ceil(this.width/8)}get bytesPerElement(){return this.#t}get byteLength(){return this.#e.byteLength}get(t){let s=0n;const i=this.#t*t;for(let n=0;n<this.#t;n++)s|=BigInt(this.#e[i+n])<<BigInt(n*8);return s}set(t,s){const i=this.#t*t;for(let n=0;n<this.#t;n++)this.#e[i+n]=Number(s>>BigInt(n*8)&C)}OR(t,s){const i=this.#t*t;for(let n=0;n<this.#t;n++)this.#e[i+n]|=Number(s>>BigInt(n*8)&C)}AND(t,s){const i=this.#t*t;for(let n=0;n<this.#t;n++)this.#e[i+n]&=Number(s>>BigInt(n*8)&C)}XOR(t,s){const i=this.#t*t;for(let n=0;n<this.#t;n++)this.#e[i+n]^=Number(s>>BigInt(n*8)&C)}[h.Send](){return[this.width,this.length,this.#e]}static[h.Receive]([t,s,i]){return new this(t,s,i)}}function l(e,t,s=Error){if(!e)throw new s(t)}class P{#t;#e;constructor(t,s=new Int32Array(new SharedArrayBuffer(4))){this.#t=t,this.#e=s}get isLocked(){return this.#e[0]===1}UNSAFE_getData(){return this.#t}async request(t){await this.#n();const s=await t(this.#t);return this.#s(),s}async#n(){for(;;){if(Atomics.compareExchange(this.#e,0,0,1)===0)return;await Atomics.waitAsync(this.#e,0,1).value}}#s(){const t=Atomics.compareExchange(this.#e,0,1,0);Atomics.notify(this.#e,0),l(t===1,"Tried to unlock a mutex that was not locked.")}[h.Send](){return[this.#t,this.#e]}static[h.Receive]([t,s]){return new this(t,s)}}class I{static with(t,s=!1){const i=s?SharedArrayBuffer:ArrayBuffer;return new this(new Uint32Array(new i(t*4)),new Uint32Array(new i(t*4)),new Uint32Array(new i(4)))}#t;constructor(t,s,i){this.sparse=t,this.dense=s,this.#t=i}get size(){return this.#t[0]}set size(t){this.#t[0]=t}has(t){return this.dense[this.sparse[t]]===t&&this.sparse[t]<this.size}add(t){if(this.has(t))return this;if(this.sparse.length<=t)throw new RangeError("Invalid index");return this.sparse[t]=this.size,this.dense[this.size]=t,this.size++,this}delete(t){if(!this.has(t))return!1;this.size--;const s=this.sparse[t];return this.dense[s]=this.dense[this.size],this.sparse[this.dense[s]]=s,!0}clear(){this.size=0}*[Symbol.iterator](){const t=this.size;for(let s=0;s<t;s++)yield this.dense[s]}[h.Send](){return[this.sparse,this.dense,this.#t]}static[h.Receive]([t,s,i]){return new this(t,s,i)}}class T{static from(t,s,i){return new this(t,s,I.with(t.length,!0),new P(M.with(t.length,2,!0)),i)}#t;#e;#n;#s;#i;#r;constructor(t,s,i,n,o){this.#e=t,this.#n=s,this.#s=i,this.#i=n,this.#t=new Int32Array(i[h.Send]()[2].buffer),this.#r=o}add(t){this.#s.add(t)}start(){Atomics.notify(this.#t,0)}reset(){const t=this.#i.UNSAFE_getData();t.set(0,0n),t.set(1,0n);for(let s=0;s<this.#n.length;s++)this.#r.has(s)||this.#s.add(s)}async onReady(t){const{async:s,value:i}=Atomics.waitAsync(this.#t,0,0);if(!s)throw new Error("Trying to wait while there are still systems to execute");await i,t()}async*[Symbol.asyncIterator](){const t=new Set(this.#r);for(;this.#s.size+t.size>0;){const s=this.#s.size;let i=-1;await this.#i.request(n=>{const o=n.get(0),r=n.get(1);for(const a of[...t,...this.#s])if((o&this.#e[a])===0n&&(r&this.#n[a])===this.#n[a]){i=a,this.#s.delete(a),t.delete(a),n.OR(0,1n<<BigInt(a));break}}),i>-1?(yield i,await this.#i.request(n=>{n.XOR(0,1n<<BigInt(i)),n.OR(1,1n<<BigInt(i)),(this.#t[0]!==0||this.#t[0]===0&&n.get(0)===0n)&&Atomics.notify(this.#t,0)})):s!==0&&await Atomics.waitAsync(this.#t,0,s).value}}[h.Send](){return[this.#e,this.#n,this.#s,this.#i]}static[h.Receive](t){return new this(...t,new Set)}}const et=e=>(e>>>=0,31-Math.clz32(e&-e));class D{#t;#e;static with(t,s){const i=s?SharedArrayBuffer:ArrayBuffer;return new this(new Uint32Array(new i(16)),new Uint32Array(new i(t)))}constructor(t,s){this.#t=t,this.#e=s}get(){for(let s=0;s<this.#e.length&&Atomics.load(this.#t,1)!==0;s++)for(;;){const i=Atomics.load(this.#e,s);if(i===0)break;const n=et(i);if(Atomics.xor(this.#e,s,1<<n)===i)return Atomics.sub(this.#t,1,1),32*s+n}const t=Atomics.add(this.#t,0,1);if(t===4294967295)throw new Error("Too many entities spawned!");return t}free(t){(Atomics.or(this.#e,t>>5,1<<(t&31))&1<<(t&31))===0&&Atomics.add(this.#t,1,1)}[h.Send](){return[this.#t,this.#e]}static[h.Receive]([t,s]){return new this(t,s)}}function st(){return[I,P,M,T,D]}function $(e,t){const s=[...t];return[...e].reduce((i,n,o)=>i.set(n,s[o]),new Map)}class it{static fromWorld(t,s){return new this(D.with(t.maxEntities,t.threads>1),M.with(s,t.maxEntities,t.threads>1),I.with(t.maxEntities,t.threads>1))}#t;#e;constructor(t,s,i){this.#e=t,this.entityData=s,this.#t=new nt(this,s,i),this.modifiedEntities=i}__$$setComponents(t){this.#t.__$$setComponents(t)}spawn(){return this.#t.__$$setId(this.#e.get())}despawn(t){return this.#e.free(t),this.entityData.set(t,0n),this.modifiedEntities.add(t),this}get(t){return this.#t.__$$setId(t)}[h.Send](){return[this.#e,this.entityData,this.modifiedEntities]}static[h.Receive]([t,s,i]){return new this(t,s,i)}}class nt{__$$setId(t){return this.#t=t,this}__$$setComponents(t){this.#e=t}#t=0;#e;#n;#s;#i;constructor(t,s,i){this.#n=t,this.#e=null,this.#s=s,this.#i=i}initialize(t){const s=O(this.#e,t);return(this.#s.get(this.#t)&1n<<BigInt(s))===0n&&this.insert(t),this}insert(t){return this.#s.OR(this.#t,1n<<BigInt(O(this.#e,t))),this.#i.add(this.#t),this}remove(t){return this.#s.XOR(this.#t,1n<<BigInt(O(this.#e,t))),this.#i.add(this.#t),this}despawn(){this.#n.despawn(this.#t)}}function O(e,t){return[...e.keys()].indexOf(t)}function rt(e){var t;if(!e)return t=class{},t.schema={},t;class s{constructor(n,o){this.$=n,this._=o}}s.schema=e;for(const i in e){const n=Array.isArray(e)?Number(i):i;Object.defineProperty(s.prototype,n,{enumerable:!0,get(){return this.$[n][this._]},set(o){this.$[n][this._]=o}})}return s}var m=(e=>(e[e.u8=0]="u8",e[e.u16=1]="u16",e[e.u32=2]="u32",e[e.u64=3]="u64",e[e.i8=4]="i8",e[e.i16=5]="i16",e[e.i32=6]="i32",e[e.i64=7]="i64",e[e.f32=8]="f32",e[e.f64=9]="f64",e))(m||{});const L={[0]:1,[1]:2,[2]:4,[3]:8,[4]:1,[5]:2,[6]:4,[7]:8,[8]:4,[9]:8},ot={[0]:Uint8Array,[1]:Uint16Array,[2]:Uint32Array,[3]:BigUint64Array,[4]:Int8Array,[5]:Int16Array,[6]:Int32Array,[7]:BigInt64Array,[8]:Float32Array,[9]:Float64Array};function at(e,{maxEntities:t,threads:s}){const i=s>1,n=N(e.schema),o=new(i?SharedArrayBuffer:ArrayBuffer)(n*t);return F(e.schema,o,[0],t)}const N=e=>(Array.isArray(e)?e:Object.values(e)).reduce((t,s)=>t+(typeof s=="number"?L[s]:N(s.schema)),0),F=(e,t,s,i)=>{const n=Array.isArray(e);return Object.entries(e).reduce((o,[r,a],d)=>{const u=n?d:r;return typeof a=="number"?(o[u]=new ot[a](t,s[0],i),s[0]+=i*L[a]):o[u]=F(a.schema,t,s,i),o},n?[]:{})};m.u8+"",m.u16+"",m.u32+"",m.u64+"",m.i8+"",m.i16+"",m.i32+"",m.i64+"",m.f32+"",m.f64+"";function Q(e,t){return ht(e)?e.create(t):new e}function ht(e){return"create"in e&&typeof e.create=="function"}class ct{isLocalToThread(){return!1}intersectsWith(t){return!1}intoArgument(t){return t.commands}onAddSystem(t){}}var g=(e=>(e[e.Read=0]="Read",e[e.Write=1]="Write",e))(g||{});function ut(e,t){return dt(e,t)}const dt=(e,t)=>t.reduce((s,i)=>s|1n<<BigInt(e.indexOf(i)),0n);function b(e){return[e,1]}b.isMut=function(e){return Array.isArray(e)&&e.length===2&&typeof e[0]=="function"&&e[1]===1};class ft{#t;#e;#n;#s;constructor(t,s,i,n){this.entities=i,this.#e=t,this.#n=s,this.#t=this.#e.map((o,r)=>new o(this.#n[r],0)),this.#s=n}*[Symbol.iterator](){for(const t of this.entities){for(const s of this.#t)s.eid=t;yield this.#t}}testAdd(t,s){this.#i(s)&&this.entities.add(t)}#i(t){return(t&this.#s)===this.#s}}class W{constructor(t){this.components=[],this.accessType=[];for(const s of t){const i=b.isMut(s);this.components.push(i?s[0]:s),this.accessType.push(i?g.Write:g.Read)}}isLocalToThread(){return!1}intersectsWith(t){return t instanceof W?this.components.some((s,i)=>t.components.some((n,o)=>s===n&&(this.accessType[i]===g.Write||t.accessType[o]===g.Write))):!1}onAddSystem(t){this.components.forEach(s=>t.registerComponent(s)),t.registerQuery(this)}intoArgument(t){return t.queries.set(this,new ft(this.components,this.components.map(s=>t.components.get(s)),t.queries.get(this),ut([...t.components.keys()],this.components))),t.queries.get(this)}}class v{constructor(t){const s=b.isMut(t);this.resource=s?t[0]:t,this.accessType=s?g.Write:g.Read}isLocalToThread(){return!S(this.resource)}intersectsWith(t){return t instanceof v?this.resource===t.resource&&(this.accessType===g.Write||t.accessType===g.Write):!1}onAddSystem(t){t.registerResource(this.resource),S(this.resource)&&t.registerSendableClass(this.resource)}intoArgument(t){return t.resources.get(this.resource)}}class mt{isLocalToThread(){return!0}intersectsWith(t){return!0}intoArgument(t){return t}onAddSystem(t){}}function E(e){return(...t)=>new e(...t)}const j={Commands:E(ct),Query:E(W),Res:E(v),World:E(mt)};function V(e,t){return{fn:t,parameters:e}}function lt(e,t,s){const i=Array.from({length:e.length},()=>0n),n=(o,r)=>(i[o]&1n<<BigInt(r))!==0n;return t.forEach((o,r)=>{if(!!o){for(const a of o.before??[]){const d=e.indexOf(a);d!==-1&&(l(!n(r,d),`Circular dependency detected: ${e[r].fn.name} (${r}) and ${e[d].fn.name} (${d}) depend on each other.`),i[d]|=1n<<BigInt(r))}for(const a of o.after??[]){const d=e.indexOf(a);d!==-1&&(l(!n(d,r),`Circular dependency detected: ${e[r].fn.name} (${r}) and ${e[d].fn.name} (${d}) depend on each other.`),i[r]|=1n<<BigInt(d))}}}),i.forEach((o,r)=>{l(!n(r,r),`Circular dependency detected: ${e[r].fn.name} (${r}) and ${e[r].fn.name} (${r}) depend on each other.`)}),t.forEach((o,r)=>{if(!!o){if(o.beforeAll)for(const a of X(s[r]))a!==r&&(i[r]&1n<<BigInt(a))===0n&&(i[a]|=1n<<BigInt(r));if(o.afterAll)for(const a of X(s[r]))a!==r&&(i[a]&1n<<BigInt(r))===0n&&(i[r]|=1n<<BigInt(a))}}),i.forEach((o,r)=>i[r]&=s[r]),i}function*X(e){let t=0;for(;e!==0n;)(e&1n)===1n&&(yield t),e>>=1n,t++}function gt(e,t){return e.parameters.some(s=>t.parameters.some(i=>s.intersectsWith(i)||i.intersectsWith(s)))?1:0}function yt(e){return e.map(t=>e.reduce((s,i,n)=>s|BigInt(gt(t,i))<<BigInt(n),0n))}const K=V([j.World()],function(t){for(const s of t.commands.modifiedEntities)for(const i of t.queries.values())i.testAdd(s,t.commands.entityData.get(s));t.commands.modifiedEntities.clear()});class pt{#t=[];#e=[];#n=[];#s=st();#i=new Set;#r=new Set;#a=new Set;#o;#h;constructor(t,s){this.#o=t,this.#h=s,this.addSystem(K,{afterAll:!0})}get resources(){return this.#i}get queries(){return this.#r}get components(){return this.#a}get config(){return this.#o}get url(){return this.#h}addSystem(t,s){return this.#t.push(t),this.#e.push(s),this.#c(t),this}addStartupSystem(t){return this.#n.push(t),this.#c(t),this}addPlugin(t){return t(this),this}registerComponent(t){return this.#a.add(t),this}registerResource(t){return this.#i.add(t),this}registerSendableClass(t){return S(t)&&this.#s.push(t),this}registerQuery(t){return this.#r.add(t),this}async build(){const t=c.spawn(this.#o.threads-1,this.#h,this.#s),s=await c.createOrReceive(c.Context.Main,t,()=>{const u=yt(this.#t),B=lt(this.#t,this.#e,u),k=this.#t.reduce((H,Ct,It)=>(Ct.parameters.some(bt=>bt.isLocalToThread())&&H.add(It),H),new Set);return T.from(u,B,k)}),i=$(this.#a,await c.createOrReceive(c.Context.Main,t,()=>Array.from(this.#a,u=>at(u,this.#o)))),n=$(this.#i,await c.createOrReceive(c.Context.Main,t,()=>Array.from(this.#i,u=>S(u)?Q(u,this.#o):null)));c.execute(c.Context.Main,()=>{this.#i.forEach(u=>{S(u)||n.set(u,Q(u,this.#o))})});const o=$(this.#r,await c.createOrReceive(c.Context.Main,t,()=>Array.from(this.#r,()=>I.with(this.#o.maxEntities,this.#o.threads>1)))),r=await c.createOrReceive(c.Context.Main,t,()=>it.fromWorld(this.#o,i.size));r.__$$setComponents(i);const a=[],d=new G(i,n,o,t,a,s,r);return this.#t.forEach((u,B)=>a[B]=this.#u(u,d)),c.execute(c.Context.Main,()=>{for(const{execute:u,args:B}of this.#n.map(k=>this.#u(k,d)))u(...B)}),await c.createOrReceive(c.Context.Worker,t,()=>0),d}#c(t){t.parameters.forEach(s=>s.onAddSystem(this))}#u({fn:t,parameters:s},i){return{execute:t,args:s.map(n=>n.intoArgument(i))}}}function wt(e={}){return{threads:1,maxEntities:2**16,...e}}function At(e,t){const{threads:s,maxEntities:i}=e;s>1&&(l(isSecureContext,"Invalid config - Multithreading (threads > 1) requires a secure context."),l(typeof SharedArrayBuffer<"u","Invalid config - Multithreading (threads > 1) requires SharedArrayBuffer."),l(t,"Invalid config - Multithreading (threads > 1) requires a module URL parameter.")),l(s>0&&Number.isSafeInteger(s),"Invalid config - 'threads' must be a safe, positive integer (min 1)."),l(i>0&&Number.isSafeInteger(i),"Invalid config - 'maxEntities' must be a safe, positive integer.")}function St(e,t){const s=wt(e);return At(s,t),s}class G{static new(t,s){return new pt(St(t,s),s)}#t;#e;#n;#s;#i;#r;#a;constructor(t,s,i,n,o,r,a){this.#t=t,this.#e=s,this.#n=i,this.#i=o,this.#s=n,this.#r=r,this.#a=a,this.#r.onReady(()=>this.#o())}get threads(){return this.#s}get resources(){return this.#e}get queries(){return this.#n}get components(){return this.#t}get commands(){return this.#a}async update(){this.#r.reset(),this.#r.start()}async#o(){for await(const t of this.#r){const s=this.#i[t];s.execute(...s.args)}this.#r.onReady(()=>this.#o())}}function Bt(e){return e}f.Component=rt,f.Mut=b,f.P=j,f.ThreadProtocol=h,f.Type=m,f.applyCommands=K,f.default=G,f.definePlugin=Bt,f.defineSystem=V,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
