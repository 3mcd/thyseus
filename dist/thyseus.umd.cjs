(function(d,p){typeof exports=="object"&&typeof module<"u"?p(exports,require("esm-env")):typeof define=="function"&&define.amd?define(["exports","esm-env"],p):(d=typeof globalThis<"u"?globalThis:d||self,p(d.Thyseus={},d.esm_env))})(this,function(d,p){"use strict";class nt{isLocalToThread(){return!1}intersectsWith(t){return!1}intoArgument(t){return t.commands}onAddSystem(t){}}class rt{#t=[];#e=0;#s;#i;#n;#r;#o;#h;constructor(t,e,i,s,r){this.#i=t,this.#o=i,this.#n=e,this.#r=s,this.#h=r,this.#s=this.#r.map(o=>new o({},0,r))}get size(){return this.#t.reduce((t,e)=>t+e.size,0)}*[Symbol.iterator](){this.#e>=this.#s.length&&this.#s.push(...this.#r.map(i=>new i({},0,this.#h)));const t=this.#s.slice(this.#e,this.#e+this.#r.length),e=this.#e;this.#e+=this.#r.length;for(const i of this.#t){t.forEach((s,r)=>{const o=this.#s[r+e],h=i.columns.get(o.constructor);h?(t[r]=o,t[r].__$$s=h):t[r]=null});for(let s=0;s<i.size;s++){for(const r of t)r&&(r.__$$i=s);this.#o?yield t[0]:yield t}}}testAdd(t,e){this.#c(t)&&this.#t.push(e)}#c(t){for(let e=0;e<this.#i.length;e++)if((this.#i[e]&t)===this.#i[e]&&(this.#n[e]&t)===0n)return!0;return!1}}class M{#t;constructor(t){this.#t=t}get value(){return this.#t}}class b{#t;constructor(t){this.#t=t}get value(){return this.#t}}class q{#t;constructor(t){this.#t=t}get value(){return this.#t}}class x{#t;constructor(t){this.#t=t}get value(){return this.#t}}class R{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get l(){return this.#t}get r(){return this.#e}}function _(n,t,e=Error){if(!n)throw new e(t)}const U=(n,t,e=[])=>(Array.isArray(t)?t:[t]).reduce((i,s,r)=>e[r]?i:i|1n<<BigInt(n.indexOf(s)),0n);function A(n,t,e){let i=e;for(const s of Array.isArray(n)?n:[n])i=t(i,s);return i}function ot(n,t){A(t,function e(i,s){s instanceof q||s instanceof x?(Array.isArray(s.value)?s.value:[s.value]).forEach(r=>n.registerComponent(r)):s instanceof R&&(A(s.l,e),A(s.r,e))})}function ht(n,t,e,i){const s=A(i,function o(h,u){if(u instanceof q){const c=U(n,u.value);return{withs:h.withs.map(a=>a|c),withouts:h.withouts}}else if(u instanceof x){const c=U(n,u.value);return{withs:h.withs,withouts:h.withouts.map(a=>a|c)}}else if(u instanceof R){const c=A(u.l,o,h),a=A(u.r,o,h);return{withs:[...c.withs,...a.withs],withouts:[...c.withouts,...a.withouts]}}throw new Error(`Unrecognized filter (${u.constructor.name}) in Query.`)},{withs:[U(n,t,e)],withouts:[0n]}),r=s.withs.reduce((o,h,u)=>(s.withs[u]&s.withouts[u])===0n?o.add(u):o,new Set);return s.withs=s.withs.filter((o,h)=>r.has(h)),s.withouts=s.withouts.filter((o,h)=>r.has(h)),p.DEV&&_(s.withs.length>0,"Tried to construct a query that cannot match any entities."),s}class W{components=[];writes=[];optionals=[];filters;isIndividual;constructor(t,e=[]){this.isIndividual=!Array.isArray(t);const i=Array.isArray(t)?t:[t];for(const s of i){const r=s instanceof b||s instanceof M&&s.value instanceof b;this.writes.push(r),this.optionals.push(s instanceof M);const o=s instanceof b?s.value:s instanceof M?s.value instanceof b?s.value.value:s.value:s;p.DEV&&_(o.size>0,"You may not request direct access to ZSTs - use a With filter instead."),this.components.push(o)}this.filters=e}isLocalToThread(){return!1}intersectsWith(t){return t instanceof W?this.components.some((e,i)=>t.components.some((s,r)=>e===s&&(this.writes[i]||t.writes[r]))):!1}onAddSystem(t){this.components.forEach(e=>t.registerComponent(e)),ot(t,this.filters)}intoArgument(t){const{withs:e,withouts:i}=ht(t.components,this.components,this.optionals,this.filters),s=new rt(e,i,this.isIndividual,this.components,t.commands);return t.queries.push(s),s}}let D=0,S=1,C=0,g=[],y=[],w={};const $={u8:1<<0,u16:1<<1,u32:1<<2,u64:1<<3,i8:1<<4,i16:1<<5,i32:1<<6,i64:1<<7,f32:1<<8,f64:1<<9},N={u8:Uint8Array,u16:Uint16Array,u32:Uint32Array,u64:BigUint64Array,i8:Int8Array,i16:Int16Array,i32:Int32Array,i64:BigInt64Array,f32:Float32Array,f64:Float64Array},ut=(n,t,e)=>{const i=y.reduce((r,o,h)=>o<t&&h<r?h:r,y.length);if(i===y.length){g.push(n),y.push(t),w[n]=g.length===0?0:C;return}const s=g[i];g.splice(i,0,n),y.splice(i,0,t),w[n]=w[s];for(let r=i+1;r<g.length;r++)w[g[r]]+=e};function v(n,t,e,i=0){return S=Math.max(S,t),D|=i,ut(n,t,e),C+=e,w}function at(){const n={schema:D,size:Math.ceil(C/S)*S,alignment:S};D=0,C=0,S=1;for(let t=0;t<g.length;t++)w[g[t]]/=y[t];return w={},g.length=0,y.length=0,n}function m(n){return function(){return function(e,i){const s=N[n],r=v(i,s.BYTES_PER_ELEMENT,s.BYTES_PER_ELEMENT,$[n]),o=31-Math.clz32(s.BYTES_PER_ELEMENT);Object.defineProperty(e,i,{enumerable:!0,get(){return this.__$$s[n][(this.__$$b>>o)+r[i]]},set(h){this.__$$s[n][(this.__$$b>>o)+r[i]]=h}})}}}const ct=m("u8"),ft=m("u16"),lt=m("u32"),dt=m("u64"),mt=m("i8"),gt=m("i16"),pt=m("i32"),_t=m("i64"),Et=m("f32"),yt=m("f64"),wt=function(){return function(t,e){const i=v(e,Uint8Array.BYTES_PER_ELEMENT,Uint8Array.BYTES_PER_ELEMENT,$.u8);Object.defineProperty(t,e,{enumerable:!0,get(){return!!this.__$$s.u8[this.__$$b+i[e]]},set(s){this.__$$s.u8[this.__$$b+i[e]]=Number(s)}})}},$t=new TextEncoder,Tt=new TextDecoder;function bt({characterCount:n,byteLength:t}){return function(i,s){t??=n*3;const r=v(s,Uint8Array.BYTES_PER_ELEMENT,t);Object.defineProperty(i,s,{enumerable:!0,get(){return Tt.decode(this.__$$s.u8.subarray(this.__$$b+r[s],this.__$$b+r[s]+t)).split("\0")[0]},set(o){$t.encodeInto(o,this.__$$s.u8.subarray(this.__$$b+r[s],this.__$$b+r[s]+t).fill(0))}})}}function At({type:n,length:t}){return function(i,s){const r=N[n],o=v(s,r.BYTES_PER_ELEMENT,r.BYTES_PER_ELEMENT*t,$[n]),h=31-Math.clz32(r.BYTES_PER_ELEMENT);Object.defineProperty(i,s,{enumerable:!0,get(){return this.__$$s[n].subarray((this.__$$b>>h)+o[s],(this.__$$b>>h)+o[s]+t)},set(u){this.__$$s[n].set(u.subarray(0,t),(this.__$$b>>h)+o[s])}})}}function St(n){return function(e,i){const s=v(i,n.alignment,n.size,n.schema);Object.defineProperty(e,i,{enumerable:!0,get(){const r=new n(this.__$$s,0,{});return r.__$$b=this.__$$b+s[i]*n.alignment,r},set(r){this.__$$s.u8.set(r.__$$s,this.__$$b+s[i]*n.alignment)}})}}function f(){return function(t){const{schema:e,size:i,alignment:s}=at();return class extends t{static schema=e|(t.schema??0);static size=i;static alignment=s;__$$s;__$$b;#t;get __$$i(){return this.#t}set __$$i(r){this.#t=r,this.__$$b=r*this.constructor.size}constructor(r,o){super(),this.__$$s=r,this.#t=o,this.__$$b=o*this.constructor.size}}}}f.bool=wt,f.u8=ct,f.u16=ft,f.u32=lt,f.u64=dt,f.i8=mt,f.i16=gt,f.i32=pt,f.i64=_t,f.f32=Et,f.f64=yt,f.string=bt,f.array=At,f.substruct=St;function Q(n){return typeof n=="function"&&typeof n.size=="number"&&typeof n.alignment=="number"&&typeof n.schema=="number"}class O{resource;canWrite;constructor(t){const e=t instanceof b;this.resource=e?t.value:t,this.canWrite=e}isLocalToThread(){return!Q(this.resource)}intersectsWith(t){return t instanceof O?this.resource===t.resource&&(this.canWrite||t.canWrite):!1}onAddSystem(t){t.registerResource(this.resource)}intoArgument(t){return t.resources.get(this.resource)}}class zt{isLocalToThread(){return!0}intersectsWith(t){return!0}intoArgument(t){return t}onAddSystem(t){}}function E(n){return(...t)=>new n(...t)}const vt={Commands:E(nt),Query:E(W),Res:E(O),World:E(zt),Mut:E(b),Optional:E(M),With:E(q),Without:E(x),Or(n,t){return new R(n,t)}};class Bt{#t=0;#e=[];#s;fn;constructor(t,e){this.#s=t,this.fn=e}get parameters(){return this.#s(vt)}before(...t){for(const e of t)e.after(this);return this}after(...t){for(const e of t)this.#e.push(e);return this}beforeAll(){return this.#t=-1,this}afterAll(){return this.#t=1,this}getAndClearDependencies(){const t={dependencies:this.#e,implicitPosition:this.#t};return this.#e=[],this.#t=0,t}}function j(n,t){return new Bt(n,t)}class l{static schema=$.u64|$.u32;static size=8;__$$s;__$$b;#t;#e;constructor(t,e,i){this.__$$s=t,this.#t=e,this.__$$b=e*l.size,this.#e=i}get __$$i(){return this.#t}set __$$i(t){this.#t=t,this.__$$b=t*l.size}get id(){return this.__$$s.u64[this.__$$b>>3]}get index(){return this.__$$s.u32[this.__$$b>>2]}get generation(){return this.__$$s.u32[(this.__$$b>>2)+1]}insert(t){return this.#e.insertInto(this.id,t),this}remove(t){return this.#e.removeFrom(this.id,t),this}despawn(){this.#e.despawn(this.id)}}const[,...Mt]=Object.entries(N);function V(n,t){return Mt.reduce((e,[i,s])=>(($[i]&n.schema)===$[i]&&(e[i]=new s(e.buffer)),e),t)}function Z(n,t,e){const i=n.createBuffer(t.size*e);return V(t,{buffer:i,u8:new Uint8Array(i)})}function Ct(n,t,e){const i=new n.buffer.constructor(t.size*e),s=new Uint8Array(i);return s.set(n.u8),n.buffer=i,n.u8=s,V(t,n)}class L{static create(t,e,i,s){const r=t.config.getNewTableSize(0);return new this(t,e.reduce((o,h)=>(h.size>0&&o.set(h,Z(t,h,r)),o),new Map),r,i,s)}#t;columns;capacity;bitfield;#e;constructor(t,e,i,s,r){this.#t=t,this.columns=e,this.capacity=i,this.bitfield=s,this.#e=r}get id(){return this.#e}get size(){return this.#t.tableLengths[this.#e]}set size(t){this.#t.tableLengths[this.#e]=t}get isFull(){return this.capacity===this.size}delete(t){this.size--;for(const[e,i]of this.columns)i.u8.copyWithin(t*e.size,this.size*e.size,this.size*e.size+e.size),i.u8.fill(0,this.size*e.size,this.size*e.size+e.size)}move(t,e){const i=this.columns.get(l).u64[this.size-1];for(const[s,r]of this.columns)e.columns.has(s)&&e.columns.get(s).u8.set(r.u8.slice(t*s.size,t*s.size+s.size),e.size*s.size);return e.size++,this.delete(t),i}grow(t){this.capacity=t.config.getNewTableSize(this.capacity);for(const[e,i]of this.columns)this.columns.set(e,Ct(i,e,this.capacity))}incrementGeneration(t){this.columns.get(l).u32[(t<<1)+1]++}}const Lt=0x00000000ffffffffn,I=n=>Number(n&Lt),Y=256;class It{static fromWorld(t){const e=BigUint64Array.BYTES_PER_ELEMENT*Y;return new this(t,t.threads.queue(()=>new Uint32Array(t.createBuffer(e))),t.threads.queue(()=>new Uint32Array(t.createBuffer(8))),t.archetypes[0])}#t;#e;#s;#i;constructor(t,e,i,s){this.#t=t,this.#e=e,this.#s=i,this.#i=s}get isFull(){return this.#s[0]>=this.#e.length>>1}spawn(){const t=this.#i.size;for(let e=this.#n();e<t;e=this.#n())if(this.#r(e))return this.#i.columns.get(l).u64[t-e-1];return BigInt(Atomics.add(this.#s,0,1))}isAlive(t){const e=this.getTableIndex(t),i=this.getRow(t);return e===0||this.#t.archetypes[e].columns.get(l).u64[i]===t}#n(){return Atomics.load(this.#s,1)}#r(t){return t===Atomics.compareExchange(this.#s,1,t,t+1)}resetCursor(){this.#s[1]=0}grow(t){const e=BigUint64Array.BYTES_PER_ELEMENT*Math.ceil((this.#s[0]+1)/Y)*Y,i=new Uint32Array(t.createBuffer(e));i.set(this.#e),this.#e=i,t.threads.send(Rt(this.#e))}setLocations(t){this.#e=t}getTableIndex(t){return this.#e[I(t)<<1]??0}setTableIndex(t,e){this.#e[I(t)<<1]=e}getRow(t){return this.#e[(I(t)<<1)+1]??0}setRow(t,e){this.#e[(I(t)<<1)+1]=e}}class Pt extends L{constructor(t){super(t,new Map,0,0n,0)}get isFull(){return!1}move(t,e){const i=BigInt(t);return e.columns.get(l).u64[e.size]=i,e.size++,i}}function*T(n){let t=0;for(;n!==0n;)(n&1n)===1n&&(yield t),n>>=1n,t++}let qt=1;function z(n,t){function e(...i){return[n,qt++,i]}return e.channelName=n,e.onReceive=t,e}const xt=[];class B{static isMainThread=!!globalThis.document;isMainThread=B.isMainThread;static spawn(t,e){return new this(B.isMainThread?Array.from({length:t},()=>new Worker(e,{type:"module"})):[globalThis])}#t=new Map;#e=new Map;#s={};#i=[];#n;constructor(t){this.#n=t;const e=({currentTarget:i,data:[s,r,o]})=>{if(this.#t.has(r)){const h=this.#e.get(r);h.push(o),h.length===this.#n.length&&(this.#t.get(r)(h),this.#t.delete(r),this.#e.delete(r))}else s in this.#s?i.postMessage([s,r,this.#s[s](...o)]):i.postMessage([s,r,null])};for(const i of this.#n)i.addEventListener("message",e)}setListener(t,e){this.#s[t]=e}deleteListener(t){delete this.#s[t]}send(t){return this.#n.length===0?Promise.resolve(xt):new Promise(e=>{for(const i of this.#n)i.postMessage(t);this.#e.set(t[1],[]),this.#t.set(t[1],e)})}queue(t){if(B.isMainThread){const e=t();return this.#i.push(e),e}return this.#i.shift()}async wrapInQueue(t){const e="threadGroup::queue";let i;return this.isMainThread?(i=await t(),await this.send([e,0,[this.#i]])):(i=await new Promise(s=>this.setListener(e,r=>{this.#i=r,s(t())})),this.deleteListener(e)),this.#i.length=0,i}}const G=z("thyseus::getCommandQueue",n=>()=>{const t=new Map(n.commands.queue);return n.commands.queue.clear(),t}),H=z("thyseus::sendTable",n=>(t,e,i,s)=>{const r=[...T(s)].reduce((h,u,c)=>(n.components[u].size>0&&h.set(n.components[u],t.shift()),h),new Map),o=new L(n,r,e,s,i);n.archetypes[i]=o;for(const h of n.queries)h.testAdd(s,o)}),J=z("thyseus::resizeTable",n=>(t,e,i)=>{const s=n.archetypes[t];s.capacity=e;let r=0;for(const o of s.columns.keys())s.columns.set(o,i[r++])}),X=z("thyseus::resizeTableLengths",n=>t=>{n.tableLengths=t}),Rt=z("thyseus::resizeEntityLocations",n=>t=>{n.entities.setLocations(t)}),Ut=(n,t)=>{for(const[e,i]of t){const s=n.get(e);s===void 0?n.set(e,i):s!==0n&&n.set(e,s|i)}return n},F=j(({World:n})=>[n()],async function(t){t.entities.isFull&&t.entities.grow(t);const e=(await t.threads.send(G())).reduce(Ut,t.commands.queue);for(const[i,s]of e)t.moveEntity(i,s);e.clear(),t.entities.resetCursor()});function Wt(n){n.registerComponent(l),n.addSystem(F.afterAll()),n.registerThreadChannel(G),n.registerThreadChannel(H),n.registerThreadChannel(J),n.registerThreadChannel(X)}function Dt(n,t){return n.parameters.some(e=>t.parameters.some(i=>e.intersectsWith(i)||i.intersectsWith(e)))?1:0}function K(n){return n.map(t=>n.reduce((e,i,s)=>e|BigInt(Dt(t,i))<<BigInt(s),0n))}function tt(n,t,e){const i=t.map(r=>r.dependencies.reduce((o,h)=>{const u=n.indexOf(h);return u===-1?o:o|1n<<BigInt(u)},0n)),s=[...i];s.forEach(function r(o,h){for(const u of T(o))r(s[u],u),s[h]|=s[u]}),p.DEV&&s.forEach((r,o)=>{_((r&1n<<BigInt(o))===0n,`Circular Dependency Detected - Sytem #${o} (${n[o].fn.name}) depends on itself!`)});for(let r=0;r<n.length;r++){const o=t[r];if(o.implicitPosition===-1)for(const h of T(e[r]))h!==r&&(s[r]&1n<<BigInt(h))===0n&&(i[h]|=1n<<BigInt(r),s[h]|=1n<<BigInt(r));else if(o.implicitPosition===1)for(const h of T(e[r]))h!==r&&(s[h]&1n<<BigInt(r))===0n&&(i[r]|=1n<<BigInt(h),s[r]|=1n<<BigInt(h))}return i.forEach((r,o)=>i[o]&=e[o]),i}function et(n,t,e){for(const i of T(t))if(n[i]===e)return!1;return!0}let Nt=0;const P=(...n)=>{};class Ot{static fromWorld(t,e,i){const s=t.threads.queue(()=>K(e)),r=t.threads.queue(()=>tt(e,i,s)),o=t.threads.isMainThread?e.map(()=>!0):e.map(c=>!c.parameters.some(a=>a.isLocalToThread())),h=t.threads.queue(()=>t.createBuffer(8+e.length*3)),u=t.threads.queue(()=>`thyseus::ParallelExecutor${Nt++}`);return new this(t,new Uint32Array(h,0,2),new Uint8Array(h,8,e.length),new Uint8Array(h,8+e.length,e.length),new Uint8Array(h,8+e.length*2,e.length),s,r,o,u)}#t=P;#e=P;#s;#i;#n;#r;#o;#h;#c;#l;#u;#d;#a;#m;constructor(t,e,i,s,r,o,h,u,c){this.#a=t.systems,this.#m=t.arguments,this.#d=t.threads.isMainThread,this.#h=o,this.#c=h,this.#o=u,this.#s=e,this.#i=i,this.#n=s,this.#r=r,this.#u=new BroadcastChannel(c),this.#l=c,this.#u.addEventListener("message",({data:a})=>{a===0?this.#g():a===1?(this.#t(),this.#t=P):(this.#e(),this.#e=P)})}async start(){return this.#f=this.#a.length,this.#s[1]=0,this.#i.fill(1),this.#r.fill(0),this.#n.fill(0),this.#p(),this.#g()}get#f(){return this.#s[0]}set#f(t){this.#s[0]=t}async#g(){for(;this.#f>0;){let t=-1;if(await navigator.locks.request(this.#l,()=>{t=this.#i.findIndex((e,i)=>!!e&&et(this.#r,this.#c[i],0)&&et(this.#n,this.#h[i],1)&&this.#o[i]),t!==-1&&(this.#i[t]=0,this.#n[t]=1,this.#f--)}),t===-1){await this.#E();continue}await this.#a[t](...this.#m[t]),await navigator.locks.request(this.#l,()=>{this.#n[t]=0,this.#r[t]=1,Atomics.add(this.#s,1,1)}),this.#_()}this.#d&&Atomics.load(this.#s,1)!==this.#a.length&&await this.#y()}#p(){this.#u.postMessage(0)}#_(){Atomics.load(this.#s,1)===this.#a.length?this.#u.postMessage(2):this.#u.postMessage(1)}async#E(){return new Promise(t=>this.#t=t)}async#y(){return new Promise(t=>this.#e=t)}}class Yt{static fromWorld(t,e,i){const s=tt(e,i,K(e)),r=s.reduce(function o(h,u,c){for(const a of T(u))o(h,s[a],a);return h.includes(c)||h.push(c),h},[]);return new this(t,r)}#t;#e;#s;constructor(t,e){this.#t=t.systems,this.#e=t.arguments,this.#s=e}async start(){for(const t of this.#s)await this.#t[t](...this.#e[t])}}class Ft{systems=[];#t=[];#e=[];components=new Set;resources=new Set;threadChannels=[];executor;config;url;constructor(t,e){this.config=t,this.url=e,this.executor=t.threads>1?Ot:Yt,Wt(this)}addSystem(t){return this.systems.push(t),this.#t.push(t.getAndClearDependencies()),t.parameters.forEach(e=>e.onAddSystem(this)),this}addStartupSystem(t){return this.#e.push(t),t.parameters.forEach(e=>e.onAddSystem(this)),this}addPlugin(t){return t(this),this}registerComponent(t){return this.components.add(t),this}registerResource(t){return this.resources.add(t),this}registerThreadChannel(t){return this.threadChannels.push(t),this}setExecutor(t){return this.executor=t,this}async build(){const t=B.spawn(this.config.threads-1,this.url),e=await t.wrapInQueue(()=>new it(this.config,t,this.executor,[...this.components],[...this.resources],this.systems,this.#t,this.threadChannels));if(t.isMainThread){await Promise.all(Array.from(e.resources.values(),i=>i.initialize?.(e)));for(const i of this.#e)await i.fn(...i.parameters.map(s=>s.intoArgument(e)));await F.fn(e)}return e}}class kt{static fromWorld(t){return new this(t,t.entities,t.components)}queue=new Map;#t;#e;#s;#i;#n;constructor(t,e,i){this.#t=t,this.#e=e;const s=new ArrayBuffer(8);this.#i=new BigUint64Array(1),this.#s=new l({buffer:s,u8:new Uint8Array(s),u32:new Uint32Array(s),u64:this.#i},0,this),this.#n=i}spawn(){const t=this.#e.spawn();return this.#i[0]=t,this.insertInto(t,l),this.#s}despawn(t){return this.queue.set(t,0n),this}get(t){return this.#i[0]=t,this.#s}insertInto(t,e){this.queue.set(t,this.#r(t)|1n<<BigInt(this.#n.indexOf(e)))}removeFrom(t,e){this.queue.set(t,this.#r(t)^1n<<BigInt(this.#n.indexOf(e)))}#r(t){return this.queue.get(t)??this.#t.archetypes[this.#e.getTableIndex(t)].bitfield}}const Qt=(n={})=>({threads:1,maxEntities:2**16,getNewTableSize:t=>t===0?8:t*2,...n}),jt=({threads:n,maxEntities:t},e)=>{n>1&&(_(isSecureContext,"Invalid config - Multithreading (threads > 1) requires a secure context."),_(typeof SharedArrayBuffer<"u","Invalid config - Multithreading (threads > 1) requires SharedArrayBuffer."),_(e,"Invalid config - Multithreading (threads > 1) requires a module URL parameter.",TypeError)),_(Number.isInteger(n)&&0<n&&n<64,"Invalid config - 'threads' must be an integer such that 0 < threads < 64",RangeError),_(Number.isInteger(t)&&0<t&&t<2**32,"Invalid config - 'maxEntities' must be an integer such that 0 < maxEntities < 2**32",RangeError)};function Vt(n,t){const e=Qt(n);return p.DEV&&jt(e,t),e}const st=64;class it{static new(t,e){return new Ft(Vt(t,e),e)}#t;archetypeLookup=new Map;tableLengths;archetypes=[];queries=[];resources=new Map;systems=[];arguments=[];executor;commands;entities;config;threads;components;constructor(t,e,i,s,r,o,h,u){this.#t=t.threads>1?SharedArrayBuffer:ArrayBuffer,this.config=t,this.threads=e,this.tableLengths=this.threads.queue(()=>new Uint32Array(this.createBuffer(st*Uint32Array.BYTES_PER_ELEMENT))),this.archetypeLookup.set(0n,1);const c=L.create(this,[l],0n,1);c.columns.set(l,this.threads.queue(()=>c.columns.get(l))),this.archetypes.push(new Pt(this),c);for(const a of u)this.threads.setListener(a.channelName,a.onReceive(this));this.components=s,this.entities=It.fromWorld(this),this.commands=kt.fromWorld(this),this.executor=i.fromWorld(this,o,h);for(const a of r)if(Q(a)){const k=this.threads.queue(()=>Z(this,a,1));this.resources.set(a,new a(k,0,this.commands))}else e.isMainThread&&this.resources.set(a,new a);for(const a of o)this.systems.push(a.fn),this.arguments.push(a.parameters.map(k=>k.intoArgument(this)))}createBuffer(t){return new this.#t(t)}async update(){return this.executor.start()}moveEntity(t,e){if(!this.entities.isAlive(t))return;const i=this.archetypes[this.entities.getTableIndex(t)],s=this.#e(e);s.isFull&&this.#s(s);const r=this.entities.getRow(t),o=i.move(r,s);e===0n&&s.incrementGeneration(r),this.entities.setRow(o,r),this.entities.setTableIndex(t,s.id),this.entities.setRow(t,s.size-1)}#e(t){if(this.archetypeLookup.has(t))return this.archetypes[this.archetypeLookup.get(t)];if(this.archetypes.length===this.tableLengths.length){const s=this.tableLengths;this.tableLengths=new Uint32Array(this.createBuffer(s.length+st*Uint32Array.BYTES_PER_ELEMENT)),this.tableLengths.set(s),this.threads.send(X(this.tableLengths))}const e=this.archetypes.length,i=L.create(this,[...T(t)].map(s=>this.components[s]),t,e);this.archetypeLookup.set(t,e),this.archetypes.push(i),this.threads.send(H([...i.columns.values()],i.capacity,e,t));for(const s of this.queries)s.testAdd(t,i);return i}#s(t){t.grow(this),this.threads.send(J(t.id,t.capacity,[...t.columns.values()]))}}function Zt(n){return n}d.Entity=l,d.World=it,d.applyCommands=F,d.createThreadChannel=z,d.definePlugin=Zt,d.defineSystem=j,d.struct=f,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
