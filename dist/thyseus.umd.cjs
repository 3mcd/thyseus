(function(w,y){typeof exports=="object"&&typeof module<"u"?y(exports,require("esm-env")):typeof define=="function"&&define.amd?define(["exports","esm-env"],y):(w=typeof globalThis<"u"?globalThis:w||self,y(w.Thyseus={},w.esm_env))})(this,function(w,y){"use strict";function _(n,t,e=Error){if(!n)throw new e(t)}function T(n){return n+7&-8}const E={};let f,D,a,rt=0;const I=8,z=4,A=4,O=8,ot=16;function Q(){for(;Atomics.compareExchange(a,I>>2,0,1)===1;);}function P(){Atomics.store(a,I>>2,0)}function yt(n,t=!1){if(f)return f;if(typeof n=="number"){const e=t?SharedArrayBuffer:ArrayBuffer;f=new e(T(n))}else f=n;return D=new Uint8Array(f),a=new Uint32Array(f),E.buffer=f,E.u8=D,E.u16=new Uint16Array(f),E.u32=a,E.u64=new BigUint64Array(f),E.i8=new Int8Array(f),E.i16=new Int16Array(f),E.i32=new Int32Array(f),E.i64=new BigInt64Array(f),E.f32=new Float32Array(f),E.f64=new Float64Array(f),E.dataview=new DataView(f),rt=f.byteLength-4,typeof n=="number"&&(a[1]=f.byteLength-8,a[a.length-2]=f.byteLength-8,M(8)),f}function M(n){const t=T(n),e=O+t;let s=I-z;for(Q();s<rt;){const i=a[s>>2],r=i&-2;if(i!==r||r<e){s+=r;continue}const c=r-e>=ot,u=c?e:r;if(a[s>>2]=u|1,a[s+u-A>>2]=u|1,c){const l=s+e,d=r-e;a[l>>2]=d,a[l+d-A>>2]=d}return P(),s+z}throw P(),new Error(`Out of memory (requesting ${n} bytes).`)}function ct(n){if(y.DEV&&_(n%8===0,"Invalid pointer in realloc - pointer was not correctly aligned."),n===I||n===0)return;let t=n-z;Q();let e=a[t>>2]&-2,s=t+e-A;if(a[t>>2]&=-2,a[s>>2]&=-2,s!==f.byteLength-A){const i=a[t+e>>2];i&1||(s+=i,e+=i)}if(t!==0){const i=a[t-A>>2];i&1||(t-=i,e+=i)}a[t>>2]=e,a[s>>2]=e,D.fill(0,t+z,s-z),P()}function _t(n,t){if(y.DEV&&_(n%8===0,"Invalid pointer in realloc - pointer was not correctly aligned."),n===I||n===0)return M(t);const e=T(t);Q();const s=n-z,i=a[s>>2]&-2,r=i-O;if(r>=e)return P(),n;const o=s+i,c=a[o>>2];if(!(c&1)&&c-O>=e-i){const l=e-r,d=c-l>=ot,m=d?e+O:i+c;if(a[o>>2]=0,a[o-A>>2]=0,a[s>>2]=m|1,a[s+m-A>>2]=m|1,d){const x=i+c-m;a[s+m>>2]=x,a[s+m+x-A>>2]=x}return P(),n}P();const u=M(e);return Z(n,r,u),ct(n),u}function Z(n,t,e){D.copyWithin(e,n,n+t)}function ht(n,t,e){D.fill(e,n,n+t)}function Et(n){if(n===I||n===0)return I;const t=(a[n-z>>2]&-2)-O,e=M(t);return Z(n,t,e),e}function vt(){f&&(ht(0,f.byteLength,0),a[1]=f.byteLength-8,a[a.length-2]=f.byteLength-8,M(8))}const h={init:yt,alloc:M,free:ct,realloc:_t,copy:Z,copyPointer:Et,set:ht,views:E,UNSAFE_CLEAR_ALL:vt};function H(n){const t=new ArrayBuffer(T(n.constructor.size));n.__$$s??={buffer:t,u8:new Uint8Array(t),u16:new Uint16Array(t),u32:new Uint32Array(t),u64:new BigUint64Array(t),i8:new Int8Array(t),i16:new Int16Array(t),i32:new Int32Array(t),i64:new BigInt64Array(t),f32:new Float32Array(t),f64:new Float64Array(t),dataview:new DataView(t)},n.__$$b??=0}function $t(n){const t=n.constructor;for(const e of t.pointers??[])h.free(n.__$$s.u32[n.__$$b+e>>2])}class g{static size=8;static alignment=8;#t;constructor(t,e){H(this),this.#t=t,e!==void 0&&(this.__$$s.u64[0]=e)}get id(){return this.__$$s.u64[this.__$$b>>3]}get index(){return this.__$$s.u32[this.__$$b>>2]}get generation(){return this.__$$s.u32[(this.__$$b>>2)+1]}add(t){return this.#t.insertInto(this.id,t),this}addType(t){return this.#t.insertTypeInto(this.id,t),this}remove(t){return this.#t.removeFrom(this.id,t),this}despawn(){this.#t.despawn(this.id)}}class F{static createEmptyTable(t){const e=t.threads.queue(()=>{const i=h.alloc(8);return h.views.u32[i>>2]=4294967295,h.views.u32[(i>>2)+1]=4294967295,i});return new this(t,[],e,0n,0)}static createRecycledTable(t){const e=t.threads.queue(()=>{const s=t.config.getNewTableSize(0),i=h.alloc(8);return h.views.u32[i>>2]=0,h.views.u32[(i>>2)+1]=s,h.views.u32[(i>>2)+2]=h.alloc(s*g.size),i});return new this(t,[g],e,0n,1)}static create(t,e,s,i){const r=t.config.getNewTableSize(0),o=e.filter(l=>l.size>0),c=h.alloc(4*(2+o.length));h.views.u32[(c>>2)+1]=r;let u=2;for(const l of o)h.views.u32[(c>>2)+u]=h.alloc(l.size*r),u++;return new this(t,o,c,s,i)}#t;#e;#s;bitfield;#i;constructor(t,e,s,i,r){this.#t=t,this.#e=e,this.#s=s,this.bitfield=i,this.#i=r}get pointer(){return this.#s}get id(){return this.#i}get capacity(){return h.views.u32[(this.#s>>2)+1]}get size(){return h.views.u32[this.#s>>2]}set size(t){h.views.u32[this.#s>>2]=t}getColumn(t){return h.views.u32[(this.#s>>2)+2+this.#e.indexOf(t)]}hasColumn(t){return this.#e.includes(t)}delete(t){this.size--;let e=2;for(const s of this.#e){const i=h.views.u32[(this.#s>>2)+e];h.copy(i+this.size*s.size,s.size,i+t*s.size),e++}}move(t,e){e.capacity===e.size&&e.grow();const{u32:s,u64:i}=h.views;if(this.#e[0]!==g)return e.size++,BigInt(t);const r=this.getColumn(g),o=i[(r>>3)+this.size];for(const c of this.#e){const u=this.getColumn(c)+t*c.size;if(e.hasColumn(c))h.copy(u,c.size,e.getColumn(c)+e.size*c.size);else for(const l of c.pointers??[])h.free(s[u+l>>2])}return e.size++,this.delete(t),o}grow(){h.views.u32[(this.#s>>2)+1]=this.#t.config.getNewTableSize(this.capacity);let t=2;for(const e of this.#e)h.views.u32[(this.#s>>2)+t]=h.realloc(h.views.u32[(this.#s>>2)+t],e.size*this.capacity),t++}copyComponentIntoRow(t,e,s){this.hasColumn(e)&&h.copy(s,e.size,this.getColumn(e)+t*e.size)}}const bt=0x00000000ffffffffn,ut=n=>Number(n&bt),k=256,At=1n<<32n;class St{static fromWorld(t){return new this(t,t.threads.queue(()=>{const{u32:e}=h.views,s=h.alloc(4*4)>>2;return e[s+2]=h.alloc(8*k),e[s+3]=k,s}))}#t;#e;#s;constructor(t,e){this.#e=e,this.#t=t,this.#s=t.archetypes[1]}spawn(){const{u32:t,u64:e}=h.views,s=this.#s.size,i=this.#s.getColumn(g);for(let r=this.#c();r<s;r=this.#c())if(this.#o(r))return e[(i>>3)+r]+At;return BigInt(Atomics.add(t,this.#e,1))}isAlive(t){const{u32:e,u64:s}=h.views,i=this.getTableIndex(t),r=this.getRow(t),o=this.#t.archetypes[i].getColumn(g);return ut(t)<Atomics.load(e,this.#e)&&(i===0||i!==1||s[(o>>3)+r]===t)}resetCursor(){const{u32:t}=h.views;if(t[this.#e+1]=0,t[this.#e]>=this.#r){const e=Math.ceil((t[this.#e]+1)/k)*k;this.#i=h.realloc(this.#i,e*8),t[this.#e+3]=e}}getTableIndex(t){return h.views.u32[this.#n(t)]??0}setTableIndex(t,e){h.views.u32[this.#n(t)]=e}getRow(t){return h.views.u32[this.#n(t)+1]??0}setRow(t,e){h.views.u32[this.#n(t)+1]=e}getBitset(t){return this.#t.archetypes[this.getTableIndex(t)].bitfield}get#i(){return h.views.u32[this.#e+2]}set#i(t){h.views.u32[this.#e+2]=t}get#r(){return h.views.u32[this.#e+3]}set#r(t){h.views.u32[this.#e+3]=t}#n(t){return(this.#i>>2)+(ut(t)<<1)}#c(){return Atomics.load(h.views.u32,this.#e+1)}#o(t){return t===Atomics.compareExchange(h.views.u32,this.#e+1,t,t+1)}}class Tt{static fromWorld(t){const e=t.threads.queue(()=>{const i=t.components.reduce((c,u)=>c+u.size,0),r=[];let o=h.alloc(i);for(const c of t.components)r.push(o),c.size!==0&&(h.views.u8.set(new c().__$$s.u8,o),o+=c.size);return r}),s=t.threads.queue(()=>h.alloc((1+3*t.config.threads)*4));return new this(t,e,s)}#t={entityId:0n,componentId:0,dataStart:0};#e=new Map;#s;#i;#r;#n;#c;constructor(t,e,s){this.#s=t.entities,this.#i=t.components,this.#r=e,this.#n=s>>2,this.#c=3*Atomics.add(h.views.u32,this.#n,1)+this.#n+1}get#o(){return h.views.u32[this.#c]}set#o(t){h.views.u32[this.#c]=t}get#a(){return h.views.u32[this.#c+1]}set#a(t){h.views.u32[this.#c+1]=t}get#l(){return h.views.u32[this.#c+2]}set#l(t){h.views.u32[this.#c+2]=t}get#h(){return this.#l+this.#o}spawn(){const t=this.#s.spawn();return this.#u("add",t,g),h.views.u64[this.#h>>3]=t,this.#o+=8,new g(this,t)}despawn(t){this.#u("remove",t,g)}getEntityById(t){return new g(this,t)}insertInto(t,e){const s=e.constructor;y.DEV&&_(s!==g,"Tried to add Entity component, which is forbidden."),this.#u("add",t,s),s.size!==0&&(h.views.u8.set(e.__$$s.u8.subarray(e.__$$b,s.size),this.#h),this.#d(s),this.#o+=T(s.size))}insertTypeInto(t,e){y.DEV&&_(e!==g,"Tried to add Entity component, which is forbidden."),this.#u("add",t,e),e.size!==0&&(h.copy(this.#r[this.#i.indexOf(e)],e.size,this.#h),this.#d(e),this.#o+=T(e.size))}removeFrom(t,e){y.DEV&&_(e!==g,"Tried to remove Entity component, which is forbidden."),this.#u("remove",t,e)}getDestinations(){this.#e.clear();const{u8:t,u16:e,u64:s}=h.views;for(const i of this.#f()){const r=s[i+8>>3];let o=this.#e.get(r);if(o===0n)continue;const c=e[i+4>>1],u=t[i+6]===0;o??=this.#s.getBitset(r),this.#e.set(r,u?o|1n<<BigInt(c):c===0?0n:o^1n<<BigInt(c))}return this.#e}*[Symbol.iterator](){const{u16:t,u32:e,u64:s}=h.views;for(const i of this.#f())e[i>>2]!==16&&(this.#t.componentId=t[i+4>>1],this.#t.entityId=s[i+8>>3],this.#t.dataStart=i+16,yield this.#t)}reset(){const{u32:t}=h.views,e=1+t[this.#n]*3;for(let s=1;s<e;s+=3)t[this.#n+s]=0}*#f(){const{u32:t}=h.views,e=1+t[this.#n]*3;for(let s=1;s<e;s+=3){const i=t[this.#n+s+2],r=i+t[this.#n+s];for(let o=i;o<r;o+=t[o>>2])yield o}}#u(t,e,s){y.DEV&&_(this.#i.includes(s),`Tried to ${t} unregistered component (${s.name}) on an Entity.`);const i=T(16+(t==="add"?s.size:0));if(this.#a<this.#o+i){const o=(this.#o+i)*2;this.#a=o,this.#l=h.realloc(this.#l,o)}const r=this.#h;h.views.u32[r>>2]=i,h.views.u16[r+4>>1]=this.#i.indexOf(s),h.views.u8[r+6]=t==="add"?0:1,h.views.u64[r+8>>3]=e,this.#o+=16}#d(t){const e=this.#h;for(const s of t.pointers??[])h.views.u32[e+s>>2]=h.copyPointer(h.views.u32[e+s>>2])}}class It{isLocalToThread(){return!1}intersectsWith(t){return!1}intoArgument(t){return t.commands}onAddSystem(t){}}class zt{#t=[];#e=0;#s;#i;#r;#n;#c;#o;#a;constructor(t,e,s,i,r){this.#i=t,this.#r=e,this.#c=s,this.#n=i,this.#o=r.commands,this.#a=h.views,this.#s=this.#n.map(o=>{const c=o===g?new o(this.#o):new o;return c.__$$s=this.#a,c})}get size(){return this.#t.reduce((t,e)=>t+e.size,0)}*[Symbol.iterator](){this.#e>=this.#s.length&&this.#s.push(...this.#n.map(s=>{const i=s===g?new s(this.#o):new s;return i.__$$s=this.#a,i}));const t=this.#s.slice(this.#e,this.#e+this.#n.length),e=this.#e;this.#e+=this.#n.length;for(const s of this.#t){t.forEach((i,r)=>{const o=this.#s[r+e];s.hasColumn(o.constructor)?(t[r]=o,t[r].__$$b=s.getColumn(o.constructor)):t[r]=null});for(let i=0;i<s.size;i++){this.#c?yield t[0]:yield t;for(const r of t)r&&(r.__$$b+=r.constructor.size)}}}testAdd(t,e){this.#l(t)&&this.#t.push(e)}#l(t){for(let e=0;e<this.#i.length;e++)if((this.#i[e]&t)===this.#i[e]&&(this.#r[e]&t)===0n)return!0;return!1}}class V{#t;constructor(t){this.#t=t}get value(){return this.#t}}class L{#t;constructor(t){this.#t=t}get value(){return this.#t}}class G{#t;constructor(t){this.#t=t}get value(){return this.#t}}class J{#t;constructor(t){this.#t=t}get value(){return this.#t}}class X{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get l(){return this.#t}get r(){return this.#e}}const K=(n,t,e=[])=>(Array.isArray(t)?t:[t]).reduce((s,i,r)=>e[r]?s:s|1n<<BigInt(n.indexOf(i)),0n);function q(n,t,e){let s=e;for(const i of Array.isArray(n)?n:[n])s=t(s,i);return s}function Ct(n,t){q(t,function e(s,i){i instanceof G||i instanceof J?(i.value instanceof Array?i.value:[i.value]).forEach(o=>n.registerComponent(o)):i instanceof X&&(q(i.l,e),q(i.r,e))})}function Bt(n,t,e,s){const i=q(s,function o(c,u){if(u instanceof G){const l=K(n,u.value);return{withs:c.withs.map(d=>d|l),withouts:c.withouts}}else if(u instanceof J){const l=K(n,u.value);return{withs:c.withs,withouts:c.withouts.map(d=>d|l)}}else if(u instanceof X){const l=q(u.l,o,c),d=q(u.r,o,c);return{withs:[...l.withs,...d.withs],withouts:[...l.withouts,...d.withouts]}}throw new Error(`Unrecognized filter (${u.constructor.name}) in Query.`)},{withs:[K(n,t,e)],withouts:[0n]}),r=i.withs.reduce((o,c,u)=>(i.withs[u]&i.withouts[u])===0n?o.add(u):o,new Set);return i.withs=i.withs.filter((o,c)=>r.has(c)),i.withouts=i.withouts.filter((o,c)=>r.has(c)),y.DEV&&_(i.withs.length>0,"Tried to construct a query that cannot match any entities."),i}class tt{components=[];writes=[];optionals=[];filters;isIndividual;constructor(t,e=[]){this.isIndividual=!Array.isArray(t);const s=Array.isArray(t)?t:[t];for(const i of s){const r=i instanceof L||i instanceof V&&i.value instanceof L;this.writes.push(r),this.optionals.push(i instanceof V);const o=i instanceof L?i.value:i instanceof V?i.value instanceof L?i.value.value:i.value:i;y.DEV&&_(o.size>0,"You may not request direct access to ZSTs - use a With filter instead."),this.components.push(o)}this.filters=e}isLocalToThread(){return!1}intersectsWith(t){return t instanceof tt?this.components.some((e,s)=>t.components.some((i,r)=>e===i&&(this.writes[s]||t.writes[r]))):!1}onAddSystem(t){this.components.forEach(e=>t.registerComponent(e)),Ct(t,this.filters)}intoArgument(t){const{withs:e,withouts:s}=Bt(t.components,this.components,this.optionals,this.filters),i=new zt(e,s,this.isIndividual,this.components,t);return t.queries.push(i),i}}const at={u8:Uint8Array,u16:Uint16Array,u32:Uint32Array,u64:BigUint64Array,i8:Int8Array,i16:Int16Array,i32:Int32Array,i64:BigInt64Array,f32:Float32Array,f64:Float64Array};let R=1,Y=0,$=[],C=[],S={},et={};const Pt=(n,t,e)=>{const s=C.reduce((r,o,c)=>o<t&&c<r?c:r,C.length);if(s===C.length){$.push(n),C.push(t),S[n]=$.length===0?0:Y;return}const i=$[s];$.splice(s,0,n),C.splice(s,0,t),S[n]=S[i];for(let r=s+1;r<$.length;r++)S[$[r]]+=e};function W(n,t,e,s){return R=Math.max(R,t),s&&(et[n]=s),Pt(n,t,e),Y+=e,S}function Mt(){const n=[];for(const e in et)for(const s of et[e])n.push(s+S[e]);const t={size:Math.ceil(Y/R)*R,alignment:R,pointers:n};Y=0,R=1;for(let e=0;e<$.length;e++)S[$[e]]/=C[e];return S={},$.length=0,C.length=0,t}function v(n){return function(e,s){const i=at[n],r=W(s,i.BYTES_PER_ELEMENT,i.BYTES_PER_ELEMENT),o=31-Math.clz32(i.BYTES_PER_ELEMENT);Object.defineProperty(e,s,{enumerable:!0,get(){return this.__$$s[n][(this.__$$b>>o)+r[s]]},set(c){this.__$$s[n][(this.__$$b>>o)+r[s]]=c}})}}const Lt=v("u8"),qt=v("u16"),Rt=v("u32"),xt=v("u64"),Dt=v("i8"),Ot=v("i16"),Wt=v("i32"),Nt=v("i64"),Ut=v("f32"),Ft=v("f64"),kt=function(t,e){const s=W(e,Uint8Array.BYTES_PER_ELEMENT,Uint8Array.BYTES_PER_ELEMENT);Object.defineProperty(t,e,{enumerable:!0,get(){return!!this.__$$s.u8[this.__$$b+s[e]]},set(i){this.__$$s.u8[this.__$$b+s[e]]=Number(i)}})};function Vt(n){let t=n.length;for(let e=n.length-1;e>=0;e--){const s=n.charCodeAt(e);s>127&&s<=2047?t++:s>2047&&s<=65535&&(t+=2),s>=56320&&s<=57343&&e--}return t}const Yt=new TextEncoder,jt=new TextDecoder;function Qt(n,t){const e=W(t,Uint32Array.BYTES_PER_ELEMENT,Uint32Array.BYTES_PER_ELEMENT*3,[8]);Object.defineProperty(n,t,{enumerable:!0,get(){const s=this.__$$b+e[t],i=this.__$$s.u32[s>>2],r=this.__$$s.u32[s+8>>2];return jt.decode(h.views.u8.subarray(r,r+i))},set(s){const i=Vt(s),r=this.__$$b+e[t],o=this.__$$s.u32[r+4>>2];let c=this.__$$s.u32[r+8>>2];if(o<i){const u=h.realloc(c,i);c=u,this.__$$s.u32[r+4>>2]=i,this.__$$s.u32[r+8>>2]=u}this.__$$s.u32[r>>2]=i,Yt.encodeInto(s,h.views.u8.subarray(c,c+i))}})}function Zt({type:n,length:t}){return function(s,i){const r=at[n],o=W(i,r.BYTES_PER_ELEMENT,r.BYTES_PER_ELEMENT*t),c=31-Math.clz32(r.BYTES_PER_ELEMENT);Object.defineProperty(s,i,{enumerable:!0,get(){return this.__$$s[n].subarray((this.__$$b>>c)+o[i],(this.__$$b>>c)+o[i]+t)},set(u){this.__$$s[n].set(u.subarray(0,t),(this.__$$b>>c)+o[i])}})}}function Ht(n){return function(e,s){const i=W(s,n.alignment,n.size,n.pointers);Object.defineProperty(e,s,{enumerable:!0,get(){const r=new n;return r.__$$s=this.__$$s,r.__$$b=this.__$$b+i[s]*n.alignment,r},set(r){this.__$$s.u8.set(r.__$$s,this.__$$b+i[s]*n.alignment)}})}}function p(n){const{size:t,alignment:e,pointers:s}=Mt();return class extends n{static size=t;static alignment=e;static pointers=s;constructor(...i){super(...i),H(this)}}}p.bool=kt,p.u8=Lt,p.u16=qt,p.u32=Rt,p.u64=xt,p.i8=Dt,p.i16=Ot,p.i32=Wt,p.i64=Nt,p.f32=Ut,p.f64=Ft,p.string=Qt,p.array=Zt,p.substruct=Ht;function N(n){return typeof n=="function"&&typeof n.size=="number"&&typeof n.alignment=="number"}class st{resource;canWrite;constructor(t){const e=t instanceof L;this.resource=e?t.value:t,this.canWrite=e}isLocalToThread(){return!N(this.resource)}intersectsWith(t){return t instanceof st?this.resource===t.resource&&(this.canWrite||t.canWrite):!1}onAddSystem(t){t.registerResource(this.resource)}intoArgument(t){return t.resources.get(this.resource)}}class Gt{resource;constructor(t){this.resource=t}isLocalToThread(){return!N(this.resource)}intersectsWith(t){return!1}onAddSystem(t){}async intoArgument(t){const{resource:e}=this,s=new e;return N(e)&&(s.__$$s=h.views,s.__$$b=t.threads.queue(()=>h.alloc(e.size))),t.threads.isMainThread&&await s.initialize?.(),s}}class Jt{isLocalToThread(){return!0}intersectsWith(t){return!0}intoArgument(t){return t}onAddSystem(t){}}function b(n){return(...t)=>new n(...t)}const Xt={Commands:b(It),Query:b(tt),Res:b(st),World:b(Jt),SystemRes:b(Gt),Mut:b(L),Optional:b(V),With:b(G),Without:b(J),Or(n,t){return new X(n,t)}};class it{#t=0;#e=[];#s;fn;constructor(t,e){this.#s=t,this.fn=e}get parameters(){return this.#s(Xt)}before(...t){for(const e of t)e.after(this);return this}after(...t){for(const e of t)this.#e.push(e);return this}beforeAll(){return this.#t=-1,this}afterAll(){return this.#t=1,this}clone(){return new it(this.#s,this.fn)}getAndClearDependencies(){const t={dependencies:this.#e,implicitPosition:this.#t};return this.#e=[],this.#t=0,t}}function lt(n,t){return new it(n,t)}const nt=lt(({World:n})=>[n()],function(t){t.entities.resetCursor();for(const[e,s]of t.commands.getDestinations())t.moveEntity(e,s);for(const{entityId:e,componentId:s,dataStart:i}of t.commands){const r=t.entities.getTableIndex(e);r===0||r===1||t.archetypes[r].copyComponentIntoRow(t.entities.getRow(e),t.components[s],i)}t.commands.reset()});function*B(n){let t=0;for(;n!==0n;)(n&1n)===1n&&(yield t),n>>=1n,t++}let Kt=1;function ft(n,t){function e(...s){return[n,Kt++,s]}return e.channelName=n,e.onReceive=t,e}class U{static isMainThread=!!globalThis.document;isMainThread=U.isMainThread;static spawn(t,e){return new this(U.isMainThread?Array.from({length:t},()=>new Worker(e,{type:"module"})):[globalThis])}#t=new Map;#e=new Map;#s={};#i=[];#r;constructor(t){this.#r=t;const e=({currentTarget:s,data:[i,r,o]})=>{if(this.#t.has(r)){const c=this.#e.get(r);c.push(o),c.length===this.#r.length&&(this.#t.get(r)(c),this.#t.delete(r),this.#e.delete(r))}else i in this.#s?s.postMessage([i,r,this.#s[i](...o)]):s.postMessage([i,r,null])};for(const s of this.#r)s.addEventListener("message",e)}setListener(t,e){this.#s[t]=e}deleteListener(t){delete this.#s[t]}send(t){return this.#r.length===0?Promise.resolve([]):new Promise(e=>{for(const s of this.#r)s.postMessage(t);this.#e.set(t[1],[]),this.#t.set(t[1],e)})}queue(t){if(U.isMainThread){const e=t();return this.#i.push(e),e}return this.#i.shift()}async wrapInQueue(t){const e="threadGroup::queue";let s;return this.isMainThread?(s=await t(),await this.send([e,0,[this.#i]])):(s=await new Promise(i=>this.setListener(e,r=>{this.#i=r,i(t())})),this.deleteListener(e)),this.#i.length=0,s}}const dt=ft("thyseus::sendTable",n=>(t,e,s)=>{const i=[...B(s)].reduce((o,c)=>{const u=n.components[c];return u.size>0&&o.push(u),o},[]),r=new F(n,i,t,s,e);n.archetypes[e]=r;for(const o of n.queries)o.testAdd(s,r)});function te(n){n.registerComponent(g).addSystem(nt.afterAll()).registerThreadChannel(dt)}function ee(n,t){return n.parameters.some(e=>t.parameters.some(s=>e.intersectsWith(s)||s.intersectsWith(e)))?1:0}function mt(n){return n.map(t=>n.reduce((e,s,i)=>e|BigInt(ee(t,s))<<BigInt(i),0n))}function gt(n,t,e){const s=t.map(r=>r.dependencies.reduce((o,c)=>{const u=n.indexOf(c);return u===-1?o:o|1n<<BigInt(u)},0n)),i=[...s];i.forEach(function r(o,c){for(const u of B(o))r(i[u],u),i[c]|=i[u]}),y.DEV&&i.forEach((r,o)=>{_((r&1n<<BigInt(o))===0n,`Circular Dependency Detected - Sytem #${o} (${n[o].fn.name}) depends on itself!`)});for(let r=0;r<n.length;r++){const o=t[r];if(o.implicitPosition===-1)for(const c of B(e[r]))c!==r&&(i[r]&1n<<BigInt(c))===0n&&(s[c]|=1n<<BigInt(r),i[c]|=1n<<BigInt(r));else if(o.implicitPosition===1)for(const c of B(e[r]))c!==r&&(i[c]&1n<<BigInt(r))===0n&&(s[r]|=1n<<BigInt(c),i[r]|=1n<<BigInt(c))}return s.forEach((r,o)=>s[o]&=e[o]),s}function wt(n,t,e){for(const s of B(t))if(n[s]===e)return!1;return!0}let se=0;const j=(...n)=>{};class ie{static fromWorld(t,e,s){const i=t.threads.queue(()=>mt(e)),r=t.threads.queue(()=>gt(e,s,i)),o=t.threads.isMainThread?e.map(()=>!0):e.map(d=>!d.parameters.some(m=>m.isLocalToThread())),{buffer:c}=h.views,u=t.threads.queue(()=>h.alloc(8+e.length*3)),l=t.threads.queue(()=>`thyseus::ParallelExecutor${se++}`);return new this(t,new Uint32Array(c,u,2),new Uint8Array(c,u+8,e.length),new Uint8Array(c,u+8+e.length,e.length),new Uint8Array(c,u+8+e.length*2,e.length),i,r,o,l)}#t=j;#e=j;#s;#i;#r;#n;#c;#o;#a;#l;#h;#f;#u;#d;constructor(t,e,s,i,r,o,c,u,l){this.#u=t.systems,this.#d=t.arguments,this.#f=t.threads.isMainThread,this.#o=o,this.#a=c,this.#c=u,this.#s=e,this.#i=s,this.#r=i,this.#n=r,this.#h=new BroadcastChannel(l),this.#l=l,this.#h.addEventListener("message",({data:d})=>{d===0?this.#g():d===1?(this.#t(),this.#t=j):(this.#e(),this.#e=j)})}async start(){return this.#m=this.#u.length,this.#s[1]=0,this.#i.fill(1),this.#n.fill(0),this.#r.fill(0),this.#w(),this.#g()}get#m(){return this.#s[0]}set#m(t){this.#s[0]=t}async#g(){for(;this.#m>0;){let t=-1;if(await navigator.locks.request(this.#l,()=>{t=this.#i.findIndex((e,s)=>!!e&&wt(this.#n,this.#a[s],0)&&wt(this.#r,this.#o[s],1)&&this.#c[s]),t!==-1&&(this.#i[t]=0,this.#r[t]=1,this.#m--)}),t===-1){await this.#y();continue}await this.#u[t](...this.#d[t]),await navigator.locks.request(this.#l,()=>{this.#r[t]=0,this.#n[t]=1,Atomics.add(this.#s,1,1)}),this.#p()}this.#f&&Atomics.load(this.#s,1)!==this.#u.length&&await this.#_()}#w(){this.#h.postMessage(0)}#p(){Atomics.load(this.#s,1)===this.#u.length?this.#h.postMessage(2):this.#h.postMessage(1)}async#y(){return new Promise(t=>this.#t=t)}async#_(){return new Promise(t=>this.#e=t)}}class ne{static fromWorld(t,e,s){const i=gt(e,s,mt(e)),r=i.reduce(function o(c,u,l){for(const d of B(u))o(c,i[d],d);return c.includes(l)||c.push(l),c},[]);return new this(t,r)}#t;#e;#s;constructor(t,e){this.#t=t.systems,this.#e=t.arguments,this.#s=e}async start(){for(const t of this.#s)await this.#t[t](...this.#e[t])}}class re{systems=[];#t=[];#e=[];components=new Set;resources=new Set;threadChannels=[];executor;config;url;constructor(t,e){this.config=t,this.url=e,this.executor=t.threads>1?ie:ne,te(this)}addSystem(t){return this.systems.push(t),this.#t.push(t.getAndClearDependencies()),t.parameters.forEach(e=>e.onAddSystem(this)),this}addStartupSystem(t){return this.#e.push(t),t.parameters.forEach(e=>e.onAddSystem(this)),this}addPlugin(t){return t(this),this}registerComponent(t){return this.components.add(t),this}registerResource(t){return this.resources.add(t),this}registerThreadChannel(t){return this.threadChannels.push(t),this}setExecutor(t){return this.executor=t,this}async build(){const t=U.spawn(this.config.threads-1,this.url),e=await t.wrapInQueue(()=>new pt(this.config,t,this.executor,[...this.components],[...this.resources],this.systems,this.#t,this.threadChannels));for(const s of this.systems)e.systems.push(s.fn),e.arguments.push(await Promise.all(s.parameters.map(i=>i.intoArgument(e))));if(t.isMainThread){await Promise.all(Array.from(e.resources.values(),s=>s.initialize?.(e)));for(const s of this.#e)await s.fn(...s.parameters.map(i=>i.intoArgument(e)));await nt.fn(e)}return e}}const oe=1048576,ce=(n={})=>({threads:1,memory:512*oe,getNewTableSize:t=>t===0?8:t*2,...n}),he=({threads:n,memory:t},e)=>{n>1&&(_(isSecureContext,"Invalid config - Multithreading (threads > 1) requires a secure context."),_(typeof SharedArrayBuffer<"u","Invalid config - Multithreading (threads > 1) requires SharedArrayBuffer."),_(e,"Invalid config - Multithreading (threads > 1) requires a module URL parameter.",TypeError)),_(Number.isInteger(n)&&0<n&&n<64,"Invalid config - 'threads' must be an integer such that 0 < threads < 64",RangeError),_(Number.isInteger(t)&&t<2**32,"Invalid config - 'memory' must be at most 4 GB ((2**32) - 1 bytes)")};function ue(n,t){const e=ce(n);return y.DEV&&he(e,t),e}class pt{static new(t,e){return new re(ue(t,e),e)}#t=new Map;archetypes=[];queries=[];resources=new Map;systems=[];arguments=[];commands;entities;config;threads;executor;components;constructor(t,e,s,i,r,o,c,u){this.config=t,this.threads=e,h.init(this.threads.queue(()=>h.init(t.memory,t.threads>1)));const l=F.createEmptyTable(this),d=F.createRecycledTable(this);this.archetypes.push(l,d),this.#t.set(0n,d);for(const m of u)this.threads.setListener(m.channelName,m.onReceive(this));this.components=i,this.entities=St.fromWorld(this),this.commands=Tt.fromWorld(this),this.executor=s.fromWorld(this,o,c);for(const m of r){if(!N(m)&&!e.isMainThread)continue;const x=new m;this.resources.set(m,new m),N(m)&&m.size>0&&(x.__$$s=h.views,x.__$$b=this.threads.queue(()=>h.alloc(m.size)))}}async update(){return this.executor.start()}moveEntity(t,e){if(!this.entities.isAlive(t))return;const s=this.archetypes[this.entities.getTableIndex(t)],i=this.#e(e),r=this.entities.getRow(t),o=s.move(r,i);this.entities.setRow(o,r),this.entities.setTableIndex(t,i.id),this.entities.setRow(t,i.size-1)}#e(t){let e=this.#t.get(t);if(e)return e;const s=this.archetypes.length;e=F.create(this,Array.from(B(t),i=>this.components[i]),t,s),this.#t.set(t,e),this.archetypes.push(e),this.threads.send(dt(e.pointer,s,t));for(const i of this.queries)i.testAdd(t,e);return e}}function ae(n){return n}w.Entity=g,w.World=pt,w.applyCommands=nt,w.createThreadChannel=ft,w.definePlugin=ae,w.defineSystem=lt,w.dropStruct=$t,w.initStruct=H,w.struct=p,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
